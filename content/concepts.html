<!DOCTYPE html>
<head>
    <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="description" content="Here we introduce some basic concepts & give a broad technical overview of Hudi">
<meta name="keywords" content="hudi, design, storage, views, timeline">
<title>Concepts | Hudi</title>
<link rel="stylesheet" href="css/syntax.css">


<link rel="stylesheet" type="text/css" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css">
<!--<link rel="stylesheet" type="text/css" href="css/bootstrap.min.css">-->
<link rel="stylesheet" href="css/modern-business.css">
<link rel="stylesheet" href="css/lavish-bootstrap.css">
<link rel="stylesheet" href="css/customstyles.css">
<link rel="stylesheet" href="css/theme-blue.css">

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-cookie/1.4.1/jquery.cookie.min.js"></script>
<script src="js/jquery.navgoco.min.js"></script>


<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/anchor-js/2.0.0/anchor.min.js"></script>
<script src="js/toc.js"></script>
<script src="js/customscripts.js"></script>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-93561550-1', 'auto');
  ga('send', 'pageview');

</script>

<link rel="shortcut icon" href="images/favicon.ico">

<!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
<!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
<!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
<script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
<![endif]-->

<link rel="alternate" type="application/rss+xml" title="" href="http://0.0.0.0:4000feed.xml">

    <script>
        $(document).ready(function() {
            // Initialize navgoco with default options
            $("#mysidebar").navgoco({
                caretHtml: '',
                accordion: true,
                openClass: 'active', // open
                save: false, // leave false or nav highlighting doesn't work right
                cookie: {
                    name: 'navgoco',
                    expires: false,
                    path: '/'
                },
                slide: {
                    duration: 400,
                    easing: 'swing'
                }
            });

            $("#collapseAll").click(function(e) {
                e.preventDefault();
                $("#mysidebar").navgoco('toggle', false);
            });

            $("#expandAll").click(function(e) {
                e.preventDefault();
                $("#mysidebar").navgoco('toggle', true);
            });

        });

    </script>
    <script>
        $(function () {
            $('[data-toggle="tooltip"]').tooltip()
        })
    </script>
    

</head>
<body>
<!-- Navigation -->

<nav class="navbar navbar-inverse navbar-fixed-top">
    <div class="container topnavlinks">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>

            <a class="fa fa-lg navbar-brand" href="index.html">&nbsp;<span class="projectTitle">
              <img src="images/hudi_site_logo.png" alt="Hudi logo"/>
              <!--Hudi-->
            </span><br/>
            <p class="navbar-incubate">(Incubating)</p></a>
        </div>
        <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
            <ul class="nav navbar-nav navbar-right">
                <!-- entries without drop-downs appear here -->
                
                
                
                <li><a href="news">News</a></li>
                
                
                
                <li><a href="community.html">Community</a></li>
                
                
                
                <li><a href="https://github.com/uber/hoodie" target="_blank">Code</a></li>
                
                
                
                <!-- entries with drop-downs appear here -->
                <!-- conditional logic to control which topnav appears for the audience defined in the configuration file.-->
                
                
                <li class="dropdown">
                    <a href="#" class="dropdown-toggle" data-toggle="dropdown">Developers<b class="caret"></b></a>
                    <ul class="dropdown-menu">
                        
                        
                        <li><a href="contributing.html">Contributing</a></li>
                        
                        
                        
                        <li><a href="https://cwiki.apache.org/confluence/display/HUDI" target="_blank">Wiki/Designs</a></li>
                        
                        
                        
                        <li><a href="https://issues.apache.org/jira/projects/HUDI/summary" target="_blank">Issues</a></li>
                        
                        
                        
                        <li><a href="https://cwiki.apache.org/confluence/pages/viewrecentblogposts.action?key=HUDI" target="_blank">Blog</a></li>
                        
                        
                        
                        <li><a href="https://projects.apache.org/project.html?incubator-hudi" target="_blank">Team</a></li>
                        
                        
                    </ul>
                </li>
                
                
                
			<li>



  <a class="email" title="Submit feedback" href="#" onclick="javascript:window.location='mailto:dev@hudi.apache.org?subject=Hudi Documentation feedback&body=I have some feedback about the Concepts page: ' + window.location.href;"><i class="fa fa-envelope-o"></i> Feedback</a>

<li>

		
                <!--comment out this block if you want to hide search-->
                <li>
                    <!--start search-->
                    <div id="search-demo-container">
                        <input type="text" id="search-input" placeholder="search...">
                        <ul id="results-container"></ul>
                    </div>
                    <script src="js/jekyll-search.js" type="text/javascript"></script>
                    <script type="text/javascript">
                            SimpleJekyllSearch.init({
                                searchInput: document.getElementById('search-input'),
                                resultsContainer: document.getElementById('results-container'),
                                dataSource: 'search.json',
                                searchResultTemplate: '<li><a href="{url}" title="Concepts">{title}</a></li>',
                    noResultsText: 'No results found.',
                            limit: 10,
                            fuzzy: true,
                    })
                    </script>
                    <!--end search-->
                </li>
            </ul>
        </div>
        </div>
        <!-- /.container -->
</nav>

<!-- Page Content -->
<div class="container">
    <div class="col-lg-12">&nbsp;</div>
    <!-- Content Row -->
    <div class="row">
        <!-- Sidebar Column -->
        <div class="col-md-3">

          








<ul id="mysidebar" class="nav">
    <li class="sidebarTitle">Latest Version</li>
    
    
    
    <li>
        <a href="#">Getting Started</a>
        <ul>
            
            
            
            <li><a href="index.html">Overview</a></li>
            
            
            
            
            
            
            <li><a href="quickstart.html">Quickstart</a></li>
            
            
            
            
            
            
            <li><a href="use_cases.html">Use Cases</a></li>
            
            
            
            
            
            
            <li><a href="powered_by.html">Talks & Powered By</a></li>
            
            
            
            
        </ul>
        
        
    
    <li>
        <a href="#">Documentation</a>
        <ul>
            
            
            
            <li class="active"><a href="concepts.html">Concepts</a></li>
            
            
            
            
            
            
            <li><a href="implementation.html">Implementation</a></li>
            
            
            
            
            
            
            <li><a href="configurations.html">Configurations</a></li>
            
            
            
            
            
            
            <li><a href="sql_queries.html">SQL Queries</a></li>
            
            
            
            
            
            
            <li><a href="migration_guide.html">Migration Guide</a></li>
            
            
            
            
            
            
            <li><a href="incremental_processing.html">Incremental Processing</a></li>
            
            
            
            
            
            
            <li><a href="admin_guide.html">Admin Guide</a></li>
            
            
            
            
            
            
            <li><a href="comparison.html">Comparison</a></li>
            
            
            
            
        </ul>
        
        
        
        <!-- if you aren't using the accordion, uncomment this block:
           <p class="external">
               <a href="#" id="collapseAll">Collapse All</a> | <a href="#" id="expandAll">Expand All</a>
           </p>
           -->
    </li>
</ul>
</div>

<!-- this highlights the active parent class in the navgoco sidebar. this is critical so that the parent expands when you're viewing a page. This must appear below the sidebar code above. Otherwise, if placed inside customscripts.js, the script runs before the sidebar code runs and the class never gets inserted.-->
<script>$("li.active").parents('li').toggleClass("active");</script>

    <!-- Content Column -->
    <div class="col-md-9">
        <div class="post-header">
   <h1 class="post-title-main">Concepts</h1>
</div>



<div class="post-content">

   
    <div class="summary">Here we introduce some basic concepts & give a broad technical overview of Hudi</div>
   

    


    

  <p>Apache Hudi (pronounced “Hudi”) provides the following primitives over datasets on DFS</p>

<ul>
  <li>Upsert                     (how do I change the dataset?)</li>
  <li>Incremental consumption    (how do I fetch data that changed?)</li>
</ul>

<p>In order to achieve this, Hudi maintains a <code class="highlighter-rouge">timeline</code> of all activity performed on the dataset, that helps provide <code class="highlighter-rouge">instantaenous</code> views of the dataset,
while also efficiently supporting retrieval of data in the order of arrival into the dataset.
Such key activities include</p>

<ul>
  <li><code class="highlighter-rouge">COMMITS</code> - A single commit captures information about an <strong>atomic write</strong> of a batch of records into a dataset.
    Commits are identified by a monotonically increasing timestamp, denoting the start of the write operation.</li>
  <li><code class="highlighter-rouge">CLEANS</code> - Background activity that gets rid of older versions of files in the dataset, that are no longer needed.</li>
  <li><code class="highlighter-rouge">DELTA_COMMITS</code> - A single commit captures information about an <strong>atomic write</strong> of a batch of records into a
 MergeOnRead storage type of dataset</li>
  <li><code class="highlighter-rouge">COMPACTIONS</code> - Background activity to reconcile differential data structures within Hudi e.g: moving updates from row based log files to columnar formats.</li>
</ul>

<figure><img class="docimage" src="images/Hudi_timeline.png" alt="Hudi_timeline.png" /></figure>

<p>Example above shows upserts happenings between 10:00 and 10:20 on a Hudi dataset, roughly every 5 mins, leaving commit metadata on the Hudi timeline, along
with other background cleaning/compactions. One key observation to make is that the commit time indicates the <code class="highlighter-rouge">arrival time</code> of the data (10:20AM), while the actual data
organization reflects the actual time or <code class="highlighter-rouge">event time</code>, the data was intended for (hourly buckets from 07:00). These are two key concepts when reasoning about tradeoffs between latency and completeness of data.</p>

<p>When there is late arriving data (data intended for 9:00 arriving &gt;1 hr late at 10:20), we can see the upsert producing new data into even older time buckets/folders.
With the help of the timeline, an incremental query attempting to get all new data that was committed successfully since 10:00 hours, is able to very efficiently consume
only the changed files without say scanning all the time buckets &gt; 07:00.</p>

<h2 id="terminologies">Terminologies</h2>

<ul>
  <li><code class="highlighter-rouge">Hudi Dataset</code>
 A structured hive/spark dataset managed by Hudi. Hudi supports both partitioned and non-partitioned Hive tables.</li>
  <li><code class="highlighter-rouge">Commit</code>
 A commit marks a new batch of data applied to a dataset. Hudi maintains  monotonically increasing timestamps to track commits and guarantees that a commit is atomically
 published.</li>
  <li><code class="highlighter-rouge">Commit Timeline</code>
 Commit Timeline refers to the sequence of Commits that was applied in order on a dataset over its lifetime.</li>
  <li><code class="highlighter-rouge">File Slice</code>
 Hudi provides efficient handling of updates by having a fixed mapping between record key to a logical file Id.
 Hudi uses MVCC to provide atomicity and isolation of readers from a writer. This means that a logical fileId will
 have many physical versions of it. Each of these physical version of a file represents a complete view of the
 file as of a commit and is called File Slice</li>
  <li><code class="highlighter-rouge">File Group</code>
 A file-group is a file-slice timeline. It is a list of file-slices in commit order. It is identified by <code class="highlighter-rouge">file id</code></li>
</ul>

<h2 id="storage-types">Storage Types</h2>

<p>Hudi storage types capture how data is indexed &amp; laid out on the filesystem, and how the above primitives and timeline activities are implemented on top of
such organization (i.e how data is written). This is not to be confused with the notion of Read Optimized &amp; Near-Real time tables, which are merely how the underlying data is exposed
to the queries (i.e how data is read).</p>

<p>Hudi (will) supports the following storage types.</p>

<table>
  <thead>
    <tr>
      <th>Storage Type</th>
      <th>Supported Tables</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>Copy On Write</td>
      <td>Read Optimized</td>
    </tr>
    <tr>
      <td>Merge On Read</td>
      <td>Read Optimized + Near Real-time</td>
    </tr>
  </tbody>
</table>

<ul>
  <li>Copy On Write : A heavily read optimized storage type, that simply creates new versions of files corresponding to the records that changed.</li>
  <li>Merge On Read : Also provides a near-real time datasets in the order of 5 mins, by shifting some of the write cost, to the reads and merging incoming and on-disk data on-the-fly</li>
</ul>

<p>Regardless of the storage type, Hudi organizes a datasets into a directory structure under a <code class="highlighter-rouge">basepath</code>,
very similar to Hive tables. Dataset is broken up into partitions, which are folders containing files for that partition.
Each partition uniquely identified by its <code class="highlighter-rouge">partitionpath</code>, which is relative to the basepath.</p>

<p>Within each partition, records are distributed into multiple files. Each file is identified by an unique <code class="highlighter-rouge">file id</code> and the <code class="highlighter-rouge">commit</code> that
produced the file. Multiple files can share the same file id but written at different commits, in case of updates.</p>

<p>Each record is uniquely identified by a <code class="highlighter-rouge">record key</code> and mapped to a file id forever. This mapping between record key
and file id, never changes once the first version of a record has been written to a file. In short, the
 <code class="highlighter-rouge">file id</code> identifies a group of files, that contain all versions of a group of records.</p>

<h2 id="copy-on-write">Copy On Write</h2>

<p>As mentioned above, each commit on Copy On Write storage, produces new versions of files. In other words, we implicitly compact every
commit, such that only columnar data exists. As a result, the write amplification (number of bytes written for 1 byte of incoming data)
 is much higher, where read amplification is close to zero. This is a much desired property for a system like Hadoop, which is predominantly read-heavy.</p>

<p>Following illustrates how this works conceptually, when  data written into copy-on-write storage  and two queries running on top of it.</p>

<figure><img class="docimage" src="images/hudi_cow.png" alt="hudi_cow.png" /></figure>

<p>As data gets written, updates to existing file ids, produce a new version for that file id stamped with the commit and
inserts allocate a new file id and write its first version for that file id. These file versions and their commits are color coded above.
Normal SQL queries running against such dataset (eg: <code class="highlighter-rouge">select count(*)</code> counting the total records in that partition), first checks the timeline for latest commit
and filters all but latest versions of each file id. As you can see, an old query does not see the current inflight commit’s files colored in pink,
but a new query starting after the commit picks up the new data. Thus queries are immune to any write failures/partial writes and only run on committed data.</p>

<p>The intention of copy on write storage, is to fundamentally improve how datasets are managed today on Hadoop through</p>

<ul>
  <li>First class support for atomically updating data at file-level, instead of rewriting whole tables/partitions</li>
  <li>Ability to incremental consume changes, as opposed to wasteful scans or fumbling with heuristical approaches</li>
  <li>Tight control file sizes to keep query performance excellent (small files hurt query performance considerably).</li>
</ul>

<h2 id="merge-on-read">Merge On Read</h2>

<p>Merge on read storage is a superset of copy on write, in the sense it still provides a read optimized view of the dataset via the Read Optmized table.
But, additionally stores incoming upserts for each file id, onto a <code class="highlighter-rouge">row based append log</code>, that enables providing near real-time data to the queries
 by applying the append log, onto the latest version of each file id on-the-fly during query time. Thus, this storage type attempts to balance read and write amplication intelligently, to provide near real-time queries.
The most significant change here, would be to the compactor, which now carefully chooses which append logs need to be compacted onto
their columnar base data, to keep the query performance in check (larger append logs would incur longer merge times with merge data on query side)</p>

<p>Following illustrates how the storage works, and shows queries on both near-real time table and read optimized table.</p>

<figure><img class="docimage" src="images/hudi_mor.png" alt="hudi_mor.png" style="max-width: 1000px" /></figure>

<p>There are lot of interesting things happening in this example, which bring out the subleties in the approach.</p>

<ul>
  <li>We now have commits every 1 minute or so, something we could not do in the other storage type.</li>
  <li>Within each file id group, now there is an append log, which holds incoming updates to records in the base columnar files. In the example, the append logs hold
 all the data from 10:05 to 10:10. The base columnar files are still versioned with the commit, as before.
 Thus, if one were to simply look at base files alone, then the storage layout looks exactly like a copy on write table.</li>
  <li>A periodic compaction process reconciles these changes from the append log and produces a new version of base file, just like what happened at 10:05 in the example.</li>
  <li>There are two ways of querying the same underlying storage: ReadOptimized (RO) Table and Near-Realtime (RT) table, depending on whether we chose query performance or freshness of data.</li>
  <li>The semantics around when data from a commit is available to a query changes in a subtle way for the RO table. Note, that such a query
 running at 10:10, wont see data after 10:05 above, while a query on the RT table always sees the freshest data.</li>
  <li>When we trigger compaction &amp; what it decides to compact hold all the key to solving these hard problems. By implementing a compacting
 strategy, where we aggressively compact the latest partitions compared to older partitions, we could ensure the RO Table sees data
 published within X minutes in a consistent fashion.</li>
</ul>

<p>The intention of merge on read storage, is to enable near real-time processing directly on top of Hadoop, as opposed to copying
data out to specialized systems, which may not be able to handle the data volume.</p>

<h2 id="trade-offs-when-choosing-different-storage-types-and-views">Trade offs when choosing different storage types and views</h2>

<h3 id="storage-types-1">Storage Types</h3>

<table>
  <thead>
    <tr>
      <th>Trade-off</th>
      <th>CopyOnWrite</th>
      <th>MergeOnRead</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>Data Latency</td>
      <td>Higher</td>
      <td>Lower</td>
    </tr>
    <tr>
      <td>Update cost (I/O)</td>
      <td>Higher (rewrite entire parquet)</td>
      <td>Lower (append to delta file)</td>
    </tr>
    <tr>
      <td>Parquet File Size</td>
      <td>Smaller (high update(I/0) cost)</td>
      <td>Larger (low update cost)</td>
    </tr>
    <tr>
      <td>Write Amplification</td>
      <td>Higher</td>
      <td>Lower (depending on compaction strategy)</td>
    </tr>
  </tbody>
</table>

<h3 id="hudi-views">Hudi Views</h3>

<table>
  <thead>
    <tr>
      <th>Trade-off</th>
      <th>ReadOptimized</th>
      <th>RealTime</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>Data Latency</td>
      <td>Higher</td>
      <td>Lower</td>
    </tr>
    <tr>
      <td>Query Latency</td>
      <td>Lower (raw columnar performance)</td>
      <td>Higher (merge columnar + row based delta)</td>
    </tr>
  </tbody>
</table>


    <div class="tags">
        
    </div>

    

</div>

<hr class="shaded"/>

<footer>
            <div class="row">
                <div class="col-lg-12 footer">
                  <p>
                  Copyright &copy; <span id="copyright-year">2019</span> <a href="https://apache.org">The Apache Software Foundation</a>,
                  Licensed under the Apache License, Version 2.0<br>
                  Apache and the Apache feather logo are trademarks of The Apache Software Foundation.| <a href="/privacy">Privacy Policy</a><br>
                  <a class="footer-link-img" href="https://apache.org">
                    <img src="images/asf_logo.svg" alt="The Apache Software Foundation" height="100px" widh="50px"></a>
                  </p>
                  <p>
                  Apache Hudi is an effort undergoing incubation at The Apache Software Foundation (ASF), sponsored by the <a href="http://incubator.apache.org/">Apache Incubator</a>.
                  Incubation is required of all newly accepted projects until a further review indicates that the infrastructure, communications, and decision making process have
                  stabilized in a manner consistent with other successful ASF projects. While incubation status is not necessarily a
                  reflection of the completeness or stability of the code, it does indicate that the project has yet to be fully endorsed by the ASF.
                  </p>
                </div>
            </div>
</footer>


    </div>
    <!-- /.row -->
</div>
<!-- /.container -->
    </div>

</body>

</html>